networks:
  mangabaka-network:
    driver: bridge

services:
  postgresql:
    container_name: mangabaka-postgresql
    image: postgres:alpine3.16
    environment:
      POSTGRES_DB: ${PG_DB_NAME}
      POSTGRES_PASSWORD: ${PG_PASSWORD}
      POSTGRES_USER: ${PG_USERNAME}
    ports:
      - "4321:5432"
    volumes:
      - ../../backend/src/main/resources/docker/sql:/docker-entrypoint-initdb.d
    networks:
      - mangabaka-network
    restart: always

  # NOTE: Versão onde o Build é feito localmente e copiado para dentro do container
  jetty:
    image: jetty:12.0.22-jdk17
    container_name: mangabaka-jetty
    depends_on:
      - postgresql
    ports:
      - "8080:9090"
    environment:
      BACKEND_MODE: ${BACKEND_MODE}
      POSTGRES_PASSWORD: ${PG_PASSWORD}
      POSTGRES_USER: ${PG_USERNAME}
      POSTGRES_JDBC_URL: ${PG_JDBC_URL}
    volumes:
      - ../../backend/build/libs/backend.war:/var/lib/jetty/webapps/ROOT.war
      - ../../backend/.env:/var/lib/jetty/.env
      - ~/docker:/app/data/mangabaka
    command: >
      --module=ee10-deploy,ee10-webapp,http,ee10-annotations,ee10-servlet
      -Djetty.http.port=9090
      -Djetty.deploy.scanInterval=10
      -Dlog4j.debug=true
    networks:
      - mangabaka-network
    restart: always